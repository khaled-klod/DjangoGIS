<!DOCTYPE html>
<html>

<head>
  <title>Geolocation</title>
  <link rel="stylesheet" href="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/css/ol.css"
    type="text/css">
  <style>
    .map {
      height: 400px;
      width: 100%;
    }
  </style>
  <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.1/jquery.min.js"></script>
  <script src="https://cdn.rawgit.com/openlayers/openlayers.github.io/master/en/v5.3.0/build/ol.js"></script>
</head>
<!-- <body onload="init()"> -->

<body onload="init()">
  <div id="map" class="map"></div>
  <div id="info" style="display: none;"></div>
  <div id="mouse-position"></div>

  <form class="form-inline">
    <label>Geometry type &nbsp;</label>
    <select id="type">
      <option value="None">None</option>
      <option value="Point">Point</option>
      <option value="LineString">LineString</option>
      <option value="Polygon">Polygon</option>
      <option value="Circle">Circle</option>

    </select>
  </form>

  <select id="layer-select">
    <option value="Aerial">Aerial</option>
    <option value="AerialWithLabels" selected>Aerial with labels</option>
    <option value="Road">Road (static)</option>
    <option value="RoadOnDemand">Road (dynamic)</option>
    <option value="collinsBart">Collins Bart</option>
    <option value="ordnanceSurvey">Ordnance Survey</option>
  </select>

  {% load static %}

  <form id="form" method="post" enctype="multipart/form-data">
    {% csrf_token %}
    <input id="layer_file" name="myfile" type="file" accept="text/*">
    <input id="layer_submit" name="Submit" type="submit">

  </form>

  <input type="checkbox" name="vehicle1" value="Bike"> I have a bike<br>
  <div id="layer_checkbox"></div>

  <!-- <input id="user-input" name="myfile" type="file"  accept="text/*">
<button type="button" id="sender">Save Layer</button><br>
<p id="p-text">foo bar</p> -->

  <!-- {% if uploaded_file_url %} -->

  <!-- <p id="upload_finished" onchange="addLayerFunc(uploaded_file_url)">File uploaded at: {{ uploaded_file_url }}</p> -->
  <!-- {% endif %} -->

  <!-- <input id="upload_finished" onclick=addLayerFunc() value="AddLayer" type="button"> -->

  {% load staticfiles %}
  <script src="{% static "world/js/fileUpload.js" %}"></script>


  <script>

    var url;
    var map;
    // init: delete media files
    function init(){
      
    }
    // Mouse Pos
    var mousePositionControl = new ol.control.MousePosition({
      coordinateFormat: ol.coordinate.createStringXY(4),
      projection: 'EPSG:4326',
      // comment the following two lines to have the mouse position
      // be placed within the map.
      className: 'custom-mouse-position',
      target: document.getElementById('mouse-position'),
      undefinedHTML: '&nbsp;'
    });



    var vectorSource = new ol.source.Vector({
      format: new ol.format.KML(),
      //url : 'https://openlayers.org/en/v5.1.3/examples/data/geojson/countries.geojson'
      // url : './static/world/js/countries.geojson'
      url: ''
    }
    )
    // vector.set("name",file_name,true);
    var raster = new ol.layer.Tile({
      source: new ol.source.OSM()
    });
    raster.set("name", "OSM", true);

    var vector = new ol.layer.Vector({
      source: vectorSource
    });
    vector.set("name", "Vector", true);

    map = new ol.Map({
      controls: ol.control.defaults().extend([mousePositionControl]),
      target: 'map',
      layers: [
        raster,
        vector
      ],
      view: new ol.View({
        center: ol.proj.fromLonLat([9.87, 37.27]),
        zoom: 13
      })
    });

    map.getLayers().forEach(function (layer) {
      console.log(layer.get("name"))

      appendCheckBox(layer.get("name"))
    });




    // UPLOAD
    $("form").submit(function (evt) {
      evt.preventDefault();
      var formData = new FormData($(this)[0]);
      $.ajax({
        url: '{% url 'get_response' %}',
        type: 'POST',
        data: formData,
        async: true,
        cache: false,
        contentType: false,
        enctype: 'multipart/form-data',
        processData: false,
        success: function (response) {
          addLayerFunc(response.respond, response.file_name);
        }
      });
      return false;
    });


    function addLayerFunc(uploaded_file_url, file_name) {
      var uploaded_file_url = uploaded_file_url;
      console.log(uploaded_file_url)
      console.log(file_name)
      var vectorSource = new ol.source.Vector({
        format: new ol.format.KML(),
        //url : 'https://openlayers.org/en/v5.1.3/examples/data/geojson/countries.geojson'
        // url : './static/world/js/countries.geojson'
        // url: './static/world/js/Secteur Habib Hadded.kml'
        // url: uploaded_file_url
        // url: './static/world/js/rond point ain meriem.kml'
        url: '.' + uploaded_file_url

      }
      );
      var vector = new ol.layer.Vector({
        source: vectorSource
      })
      vector.set("name", file_name, true);
      map.addLayer(vector);
      appendCheckBox(file_name)


      // console.info(map.getView().getCenter());
      // console.info(map.getView().getZoom());
    }
    function removeLayer() { }

    function appendCheckBox(name) {
      var myDiv = document.getElementById("layer_checkbox");

      // creating checkbox element 
      var checkbox = document.createElement('input');

      // Assigning the attributes 
      // to created checkbox 
      checkbox.type = "checkbox";
      checkbox.name = "name";
      checkbox.value = "value";
      checkbox.id = name;
      checkbox.checked = true;
      // checkbox.onchange= toggleCheckBox(checkbox)
      checkbox.addEventListener('change', (event) => {
        toggleCheckBox(checkbox)
      })


      // creating label for checkbox 
      var label = document.createElement('label');

      // assigning attributes for  
      // the created label tag  
      label.htmlFor = "id";

      // appending the created text to  
      // the created label tag  
      label.appendChild(document.createTextNode(name));

      // appending the checkbox 
      // and label to div 
      myDiv.appendChild(checkbox);
      myDiv.appendChild(label);
    }

    function toggleCheckBox(checkbox) {

      map.getLayers().forEach(function (layer) {
        if (checkbox.id == layer.get("name")) {
          console.log("Before: ", layer.get("name"), layer.getVisible());
          layer.setVisible(!layer.getVisible());
          console.log("After Toggle: ", layer.get("name"), layer.getVisible());

        }


      });

    }


    // var inputElement = document.getElementById("upload_finished")
    // inputElement.onchange = function (event) {
    //   // var fileList = inputElement.files;
    //   // console.log(fileList);

    //   var vectorSource = new ol.source.Vector({
    //     format: new ol.format.KML(),
    //     //url : 'https://openlayers.org/en/v5.1.3/examples/data/geojson/countries.geojson'
    //     // url : './static/world/js/countries.geojson'
    //     url: './static/world/js/lycee.kml'
    //   }
    //   );
    //   var vector = new ol.layer.Vector({
    //     source: vectorSource
    //   })

    //   map.addLayer(vector);
    //   console.log(map.getLayers());

    // }

    //DRAW

    var typeSelect = document.getElementById('type');

    var draw; // global so we can remove it later

    function addInteraction() {
      var value = typeSelect.value;
      if (value !== 'None') {
        draw = new ol.interaction.Draw({
          source: vectorSource,
          type: typeSelect.value
        });
        map.addInteraction(draw);
      }
    }


    /**
     * Handle change event.
     */
    typeSelect.onchange = function () {
      map.removeInteraction(draw);
      addInteraction();
    };

    addInteraction();

    //Tiled ArcGis MapServer
//     var styles = [
//       'Road',
//       'RoadOnDemand',
//       'Aerial',
//       'AerialWithLabels',
//       'collinsBart',
//       'ordnanceSurvey'
//     ];

// var layers = [];
//       var i, ii;
//       for (i = 0, ii = styles.length; i < ii; ++i) {
//         layers.push(new ol.layer.Tile({
//           visible: false,
//           preload: Infinity,
//           source: new ol.source.BingMaps({
//             key: 'AlFUd_XQAVXIY3oKCQ9I0edIid5neGaE71veuiKzEBP2v6ZbLlTx9S3vmrZsc5_x',
//             imagerySet: styles[i]
//             // use maxZoom 19 to see stretched tiles instead of the BingMaps
//             // "no photos at this zoom level" tiles
//             // maxZoom: 19
//           })
//         }));
//       }



//       var map = new ol.Map({
//         layers: layers,
//         loadTilesWhileInteracting: true,
//         target: 'map',
//         view: new ol.View({
//           center: [-10997148, 4569099],
//           zoom: 4
//         })
//       });

//       var select = document.getElementById('layer-select');
//       function onChange() {
//         var style = select.value;
//         for (var i = 0, ii = layers.length; i < ii; ++i) {
//           layers[i].setVisible(styles[i] === style);
//         }
//       }
//       select.addEventListener('change', onChange);
//       onChange();






  </script>
</body>

</html>